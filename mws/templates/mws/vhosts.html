{% extends 'project-light/campl-mws.html' %}
{% load static %}
{% block page_content %}
    <div class="campl-column12 campl-main-content">
        <div class="campl-content-container">

            <h1>Web Server for the MWS "{{ vm.site.name }}"</h1>
            <table class="campl-table-bordered campl-table-striped campl-table campl-vertical-stacking-table">
                <thead>
                    <tr>
                        <th>Web server</th>
                        <th>Domain Names associated</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for vhost in vm.vhosts.all %}
                    <tr>
                        <td>
                            {{ vhost.name }}
                        </td>
                        <td>
                            {% for domain_name in vhost.sorted_domain_names %}
                                {{ domain_name.name }},
                            {% endfor %}
                        </td>
                        <td style="width: 160px;">
                            <a href="{% url 'sitesmanagement.views.domains_management' vhost_id=vhost.id %}">
                                <i title="Domains associated to this vhost" class="fa fa-link fa-2x"></i>
                            </a>
                            <a href="{% url 'sitesmanagement.views.certificates' vhost_id=vhost.id %}">
                                <i title="TLS/SSL" class="fa fa-lock fa-2x"></i>
                            </a>
                            <a class="delete_vhost" data-toggle="confirmation" data-href="javascript:delete_vhost('{% url 'sitesmanagement.views.delete_vhost' vhost_id=vhost.id %}')" href="#">
                                <i title="Delete" class="fa fa-trash-o fa-2x"></i>
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <p><a id="add_vhost_button" href="#" class="campl-primary-cta">Add a new Web Server</a></p>

            <div id="add_vhost_div" style="display: none; margin-top: 20px">
                <form action={% url 'sitesmanagement.views.add_vhost' vm_id=vm.id %} method="post">{% csrf_token %}
                    <fieldset>
                        <div id="vhost_form">
                            {{ vhost_form.as_p }}
                        </div>
                        <p><input type="submit" value="Submit" class="campl-btn campl-primary-cta"/></p>
                    </fieldset>
                </form>
            </div>

        </div>
    </div>
{% endblock %}

{% block campl_foot_js %}
    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function delete_vhost(url) {
            $.ajax({
                url: url,
                type: 'DELETE',
                success: function(result) {
                    location.reload();
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                crossDomain: false
            });
        }

        $(document).ready(function() {
            $('[data-toggle="confirmation"]').confirmation({singleton:true, popout:true, placement:'top'});
            $('#add_vhost_button').click(function() {
                $('#add_vhost_div').show("fast")
            })
        })
    </script>
{% endblock %}