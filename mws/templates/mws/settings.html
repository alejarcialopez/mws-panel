{% extends 'project-light/campl-mws.html' %}
{% load static %}
{% block page_content %}
    <div class="view view-focus-on view-id-focus_on view-display-id-page">
        <div class="view-header">
            <div class="campl-content-container">
                <div class="campl-heading-container">
                    <h1 id="page-title">{% if vm.primary %}Server{% else %}Test server{% endif %} settings</h1>
                </div>
            </div>
        </div>

        <div class="campl-column12">
            <div class="campl-column3">
                <div class="campl-content-container campl-side-padding">
                    <article class="node node-external-link view-mode-focus_on clearfix
                                    campl-horizontal-teaser campl-teaser campl-focus-teaser">
                        <div class="campl-focus-teaser-img">
                            <div class="campl-content-container campl-horizontal-teaser-img">
                                <a href="{% url 'sitesmanagement.views.vhosts_management' vm_id=vm.id %}">
                                    <div class="field field-name-field-external-url-image field-type-image
                                                field-label-hidden">
                                        <div class="field-items">
                                            <div class="field-item even">
                                                <img class="campl-scale-with-grid"
                                                     src="{% static "icons/site.png" %}"
                                                     height="128" style="margin: 10px;" alt="">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="campl-focus-teaser-txt">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <h3 class="campl-teaser-title">
                                    <a href="{% url 'sitesmanagement.views.vhosts_management' vm_id=vm.id %}">
                                        Web sites
                                    </a>
                                </h3>
                                <a href="{% url 'sitesmanagement.views.vhosts_management' vm_id=vm.id %}"
                                   class="ir campl-focus-link">Web sites</a>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <div class="campl-column3">
                <div class="campl-content-container campl-side-padding">
                    <article class="node node-external-link view-mode-focus_on clearfix
                                    campl-horizontal-teaser campl-teaser campl-focus-teaser">
                        <div class="campl-focus-teaser-img">
                            <div class="campl-content-container campl-horizontal-teaser-img">
                                <a href="{% url 'sitesmanagement.views.system_packages' vm_id=vm.id %}">
                                    <div class="field field-name-field-external-url-image field-type-image
                                                field-label-hidden">
                                        <div class="field-items">
                                            <div class="field-item even">
                                                <img class="campl-scale-with-grid"
                                                     src="{% static "icons/packages.png" %}"
                                                     height="128" style="margin: 10px;" alt="">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="campl-focus-teaser-txt">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <h3 class="campl-teaser-title">
                                    <a href="{% url 'sitesmanagement.views.system_packages' vm_id=vm.id %}">
                                        System packages
                                    </a>
                                </h3>
                                <a href="{% url 'sitesmanagement.views.system_packages' vm_id=vm.id %}"
                                   class="ir campl-focus-link">System packages</a>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <div class="campl-column3">
                <div class="campl-content-container campl-side-padding">
                    <article class="node node-external-link view-mode-focus_on clearfix
                                    campl-horizontal-teaser campl-teaser campl-focus-teaser">
                        <div class="campl-focus-teaser-img">
                            <div class="campl-content-container campl-horizontal-teaser-img">
                                <a href="{% url 'sitesmanagement.views.unix_groups' vm_id=vm.id %}">
                                    <div class="field field-name-field-external-url-image field-type-image
                                                field-label-hidden">
                                        <div class="field-items">
                                            <div class="field-item even">
                                                <img class="campl-scale-with-grid"
                                                     src="{% static "icons/user2.png" %}"
                                                     height="128" style="margin: 10px;" alt="">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="campl-focus-teaser-txt">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <h3 class="campl-teaser-title">
                                    <a href="{% url 'sitesmanagement.views.unix_groups' vm_id=vm.id %}">
                                        Unix Groups
                                    </a>
                                </h3>
                                <a href="{% url 'sitesmanagement.views.unix_groups' vm_id=vm.id %}"
                                   class="ir campl-focus-link">Unix Groups</a>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <div class="campl-column3">
                <div class="campl-content-container campl-side-padding">
                    <article class="node node-external-link view-mode-focus_on clearfix
                                    campl-horizontal-teaser campl-teaser campl-focus-teaser">
                        <div class="campl-focus-teaser-img">
                            <div class="campl-content-container campl-horizontal-teaser-img">
                                <a href="{% url 'sitesmanagement.views.change_db_root_password' vm_id=vm.id %}">
                                    <div class="field field-name-field-external-url-image field-type-image
                                                field-label-hidden">
                                        <div class="field-items">
                                            <div class="field-item even">
                                                <img class="campl-scale-with-grid"
                                                     src="{% static "icons/layers.png" %}"
                                                     height="128" style="margin: 10px;" alt="">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="campl-focus-teaser-txt">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <h3 class="campl-teaser-title">
                                    <a href="{% url 'sitesmanagement.views.change_db_root_password' vm_id=vm.id %}">
                                        Change database root password
                                    </a>
                                </h3>
                                <a href="{% url 'sitesmanagement.views.change_db_root_password' vm_id=vm.id %}"
                                   class="ir campl-focus-link">Change database root password</a>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </div>

        {% if vm.is_ready %}
            <div class="campl-column6">
                <div class="campl-content-container campl-side-padding">
                    <article class="node node-external-link view-mode-focus_on clearfix
                                    campl-horizontal-teaser campl-teaser campl-focus-teaser">
                        <div class="campl-focus-teaser-img">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <div class="field field-name-field-external-url-image field-type-image
                                            field-label-hidden">
                                    <div class="field-items">
                                        <div id="vm_status_message" class="field-item even" style="color: #ffffff">
                                            Checking the status of the {% if not vm.primary %}test {% endif %} server
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="campl-focus-teaser-txt">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <h3 class="campl-teaser-title">
                                    <a id="vm_status_message_link" href="#"
                                       onclick='$("#translucidframe")[0].style.visibility = "visible"'></a>
                                </h3>
                                <a id="vm_status_link" href="#" class="ir campl-focus-link"
                                   onclick='$("#translucidframe")[0].style.visibility = "visible"'></a>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        {% else %}
            <div class="campl-column6">
                <div class="campl-content-container campl-side-padding">
                    <article class="node node-external-link view-mode-focus_on clearfix
                                    campl-horizontal-teaser campl-teaser campl-focus-teaser">
                            <div class="campl-content-container campl-horizontal-teaser-txt">
                                <div id="vm_status_busy" class="field-item even" style="color: #ffffff">
                                    The server is busy, we are configuring it
                                </div>
                            </div>
                    </article>
                </div>
            </div>
        {% endif %}

        {% if vm.primary and vm.due_update %}
        <div class="campl-column3">
            <div class="campl-content-container campl-side-padding">
                <article class="node node-external-link view-mode-focus_on clearfix
                                campl-horizontal-teaser campl-teaser campl-focus-teaser campl-focus-teaser-red">
                    <div class="campl-focus-teaser-img">
                        <div class="campl-content-container campl-horizontal-teaser-img">
                            <a class="update_os_vm" data-href="javascript:update_os_vm('{% url 'sitesmanagement.views.update_os' vm_id=vm.id %}')" href="#">
                                <div class="field field-name-field-external-url-image field-type-image
                                            field-label-hidden">
                                    <div class="field-items">
                                        <div class="field-item even">
                                            <i class="fa fa-refresh fa-6x" style="color: orangered; margin-top: 10px; margin-left: 15px; margin-bottom: 10px;"></i>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="campl-focus-teaser-txt">
                        <div class="campl-content-container campl-horizontal-teaser-txt">
                            <h3 class="campl-teaser-title">
                                <a class="update_os_vm" data-href="javascript:update_os_vm('{% url 'sitesmanagement.views.update_os' vm_id=vm.id %}')" href="#">
                                    Update {{ vm.os_type }}
                                </a>
                            </h3>
                            <a class="update_os_vm ir campl-focus-link campl-focus-link-red" data-href="javascript:update_os_vm('{% url 'sitesmanagement.views.update_os' vm_id=vm.id %}')" href="#">
                                Update {{ vm.os_type }}
                            </a>
                        </div>
                    </div>
                </article>
            </div>
        </div>
        {% endif %}

        {% if not vm.primary %}
        <div class="campl-column3">
            <div class="campl-content-container campl-side-padding">
                <article class="node node-external-link view-mode-focus_on clearfix
                                campl-horizontal-teaser campl-teaser campl-focus-teaser campl-focus-teaser-red">
                    <div class="campl-focus-teaser-img">
                        <div class="campl-content-container campl-horizontal-teaser-img">
                            <a class="delete_vm" data-href="javascript:delete_vm('{% url 'sitesmanagement.views.delete_vm' vm_id=vm.id %}')" href="#">
                                <div class="field field-name-field-external-url-image field-type-image
                                            field-label-hidden">
                                    <div class="field-items">
                                        <div class="field-item even">
                                            <i class="fa fa-trash fa-6x" style="color: orangered; margin-top: 5px; margin-left: 15px;"></i>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                    <div class="campl-focus-teaser-txt">
                        <div class="campl-content-container campl-horizontal-teaser-txt">
                            <h3 class="campl-teaser-title">
                                <a class="delete_vm" data-href="javascript:delete_vm('{% url 'sitesmanagement.views.delete_vm' vm_id=vm.id %}')" href="#">
                                    Delete the test server
                                </a>
                            </h3>
                            <a class="delete_vm ir campl-focus-link campl-focus-link-red" data-href="javascript:delete_vm('{% url 'sitesmanagement.views.delete_vm' vm_id=vm.id %}')" href="#">
                                Delete the test server
                            </a>
                        </div>
                    </div>
                </article>
            </div>
        </div>
        {% endif %}

    </div>

    {% if not vm.primary %}
    <!-- Modal delete -->
    <div class="modal fade" id="delete_modal" tabindex="-1" role="dialog" aria-labelledby="delete_modal_label" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-body">
            Are you sure do you want to delete the test server?
          </div>
          <div class="modal-footer" style="padding: 10px 20px 10px;">
            <button type="button" class="campl-btn campl-primary-cta" data-dismiss="modal">Cancel</button>
            <a class="campl-btn campl-primary-cta campl-primary-red" id="delete_modal_button">Delete</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if vm.primary and vm.due_update %}
    <!-- Modal update os -->
    <div class="modal fade" id="update_os_modal" tabindex="-1" role="dialog" aria-labelledby="update_os_modal_label" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-body">
            Are you sure do you want to update the operating system?
          </div>
          <div class="modal-footer" style="padding: 10px 20px 10px;">
            <button type="button" class="campl-btn campl-primary-cta" data-dismiss="modal">Cancel</button>
            <a class="campl-btn campl-primary-cta campl-primary-red" id="update_os_modal_button">Update</a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

{% endblock %}


{% block campl_foot_js %}
    <script>
        $(document).ready(
            $.ajax({url: "{% url 'sitesmanagement.views.check_vm_status' vm_id=vm.id %}",
                success:function(result){
                    if (result['vm_is_on'] === undefined) {
                        $("#vm_status_message").html("We are currently experimenting a problem. ");
                        $("#vm_status_message_link").html("Please try again later.");
                    } else {
                        if (result['vm_is_on'] == true) {
                            $("#vm_status_message").html("The {% if not vm.primary %}test {% endif %} server is currently ON");
                            $("#vm_status_message_link").attr("href", "{% url 'sitesmanagement.views.reset_vm' vm_id=vm.id %}");
                            $("#vm_status_message_link").html("If it does not respond you can do a hard reset by clicking here");
                            $("#vm_status_link").attr("href", "{% url 'sitesmanagement.views.reset_vm' vm_id=vm.id %}");
                        } else if (result['vm_is_on'] == false) {
                            $("#vm_status_message").html("The {% if not vm.primary %}test {% endif %} server is currently OFF");
                            $("#vm_status_message_link").attr("href", "{% url 'sitesmanagement.views.power_vm' vm_id=vm.id %}");
                            $("#vm_status_message_link").html("Power it on");
                            $("#vm_status_link").attr("href", "{% url 'sitesmanagement.views.power_vm' vm_id=vm.id %}");
                        } else {
                            $("#vm_status_message").html("We are currently experimenting a problem.");
                            $("#vm_status_message_link").html("Please try again later.");
                        }
                    }
                }
            })
        );

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        {% if not vm.primary %}
        function delete_vm(url) {
            $.ajax({
                url: url,
                type: 'DELETE',
                success: function(result) {
                    window.location = "{% url 'sitesmanagement.views.show' site_id=site.id %}";
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                crossDomain: false
            });
        }

        $('.delete_vm').click(function() {
            $("#delete_modal_button").attr("href", $( this ).attr('data-href'));
            $('#delete_modal').modal();
        });
        {% endif %}

        {% if vm.primary and vm.due_update %}
        function update_os_vm(url) {
            $.ajax({
                url: url,
                type: 'POST',
                success: function(result) {
                    window.location = "{% url 'sitesmanagement.views.show' site_id=site.id %}";
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                },
                crossDomain: false
            });
        }

        $('.update_os_vm').click(function() {
            $("#update_os_modal_button").attr("href", $( this ).attr('data-href'));
            $('#update_os_modal').modal();
        });
        {% endif %}
    </script>
{% endblock %}
